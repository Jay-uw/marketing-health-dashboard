<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Health Dashboard - Solano Immigration Law Firm</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap');

        :root {
            --color-primary-red: #a51710;
            --color-black: #1a1a1a;
            --color-white: #ffffff;
            --color-background: #f4f4f4;
            --color-light-gray: #f0f0f0;
            --color-medium-gray: #b0b0b0;
            --color-dark-gray-text: #000000;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.07);

            /* Health Colors */
            --health-urgent: #e74c3c;
            --health-attention: #e67e22;
            --health-review: #f1c40f;
            --health-good: #2ecc71;
            --health-excellent: #1abc9c;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            color: var(--color-dark-gray-text);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: url('backgroundwebsite.jpg'); /* Ensure this file exists */
            background-color: var(--color-background); 
            background-attachment: fixed;
            background-position: center center;
            background-repeat: no-repeat;
            background-size: cover;
            overflow-x: hidden;
        }

        /* --- HEADER --- */
        header {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px 40px;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header .brand { display: flex; align-items: center; gap: 20px; }
        header img.logo { height: 50px; width: auto; }
        header h1 { font-size: 22px; margin: 0; font-weight: 700; color: var(--color-black); }

        /* --- HERO SECTION & 3D GRAPH --- */
        .hero-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            max-width: 1400px;
            margin: 60px auto;
            padding: 0 40px;
            align-items: center;
            gap: 40px;
        }

        .hero-text {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border-left: 5px solid var(--color-primary-red);
        }

        .hero-text h2 { font-size: 36px; margin-top: 0; color: var(--color-primary-red); }
        .hero-text p { font-size: 16px; line-height: 1.6; color: #555; }

        .hero-3d-container {
            width: 100%;
            height: 400px;
            position: relative;
        }

        /* --- USAGE GUIDE --- */
        .guide-section {
            max-width: 1400px;
            margin: 0 auto 60px auto;
            padding: 0 40px;
        }
        
        .guide-steps {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
        }

        .step-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .step-card:hover { transform: translateY(-5px); }
        .step-number { 
            background: var(--color-primary-red); 
            color: white; 
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 700; 
            margin: 0 auto 20px auto;
            font-size: 18px;
        }
        .step-card h3 { margin: 0 0 10px 0; font-size: 18px; }
        .step-card p { font-size: 14px; color: #666; margin: 0; }

        /* --- MAIN DASHBOARD LAYOUT --- */
        .container {
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            padding: 0 24px 40px 24px;
            box-sizing: border-box;
            flex-grow: 1;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 40px;
            align-items: flex-start;
        }

        /* --- SIDEBAR --- */
        .controls-panel {
            background: var(--color-white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 24px;
            position: sticky;
            top: 100px; 
        }

        .controls-panel h2 { margin-top: 0; font-size: 18px; border-bottom: 2px solid var(--color-primary-red); padding-bottom: 10px; margin-bottom: 24px; }
        .controls-panel h3 { font-size: 15px; font-weight: 700; color: var(--color-primary-red); margin-top: 20px; margin-bottom: 16px; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .controls-panel h3:first-of-type { margin-top: 0; }
        .control-group label { display: block; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        .control-group input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-family: 'Montserrat', sans-serif; margin-bottom: 20px; }

        /* --- DASHBOARD SECTIONS --- */
        .dashboard-sections { display: flex; flex-direction: column; gap: 40px; min-width: 0; }
        .dashboard-level { background: var(--color-white); border-radius: 12px; box-shadow: var(--shadow); padding: 24px; }
        
        /* Section Header & Filters */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-level h2 { margin: 0; font-size: 22px; }

        .result-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .result-filters select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-family: 'Montserrat', sans-serif;
            background-color: #f9f9f9;
            min-width: 200px;
        }
        
        .level-content { display: flex; flex-direction: column; gap: 30px; align-items: flex-start; }
        .data-display-area { min-width: 0; width: 100%; }
        
        /* File Upload */
        .file-upload-area { width: 100%; max-width: 300px; }
        .file-upload-btn { display: block; width: 100%; padding: 12px; background-color: var(--color-primary-red); color: var(--color-white); border: none; border-radius: 6px; cursor: pointer; text-align: center; font-weight: 700; transition: 0.2s; }
        .file-upload-btn:hover { background-color: #80110c; }
        input[type="file"] { display: none; }

        /* Summary Cards */
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { padding: 20px; border: 1px solid var(--color-light-gray); border-radius: 8px; background: #fff;}
        .card .card-title { font-size: 14px; font-weight: 600; color: #777; }
        .card .card-value { font-size: 32px; font-weight: 700; margin-top: 8px; }
        .card .card-value.red { color: var(--health-urgent); }
        
        /* Table */
        .table-container { overflow-x: auto; max-height: 70vh; border: 1px solid #eee; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 14px 18px; text-align: left; border-bottom: 1px solid var(--color-light-gray); white-space: nowrap; font-size: 14px; }
        th { background-color: #f8f9fa; font-weight: 700; font-size: 12px; text-transform: uppercase; position: sticky; top: 0; z-index: 10; color: #555; }
        
        td.video-link-cell { max-width: 200px; overflow: hidden; text-overflow: ellipsis; }
        td.video-link-cell a { color: var(--color-primary-red); text-decoration: none; font-weight: 600; }
        td.video-link-cell a:hover { text-decoration: underline; }

        .health-cell { display: flex; align-items: center; gap: 10px; }
        .health-score { font-weight: 700; padding: 3px 8px; border-radius: 12px; color: white; font-size: 12px; min-width: 25px; text-align: center;}

        /* Text Colors for KPI Metrics */
        .metric-value { font-weight: 600; }
        .text-excellent { color: var(--health-excellent); font-weight: 700; }
        .text-good { color: var(--health-good); font-weight: 600; }
        .text-review { color: #d4ac0d; font-weight: 600; }
        .text-attention { color: var(--health-attention); font-weight: 600; }
        .text-urgent { color: var(--health-urgent); font-weight: 700; }
        .text-neutral { color: var(--color-dark-gray-text); }

        /* --- FOOTER & BADGES --- */
        footer {
            background-color: var(--color-black);
            color: var(--color-medium-gray);
            padding: 60px 24px;
            margin-top: auto;
            text-align: center;
            font-size: 14px;
        }
        
        footer strong { color: white; }

        /* Badge Layout Configuration */
        .badges-wrapper {
            display: flex;
            justify-content: center;
            align-items: center; /* Vertically center items */
            gap: 40px; /* Space between badges */
            margin-top: 50px;
            flex-wrap: wrap;
        }

        .badge-item {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
        }

        .badge-item:hover {
            transform: scale(1.05);
        }

        .academy-badge img {
            height: 120px; 
            width: auto;
            display: block;
        }

        /* Styles specifically for the Credly Iframe container if needed */
        .badge-item.meta-badge {
            min-width: 150px;
            min-height: 270px;
        }
        
        /* New Version Text Styling */
        .version-display {
            font-family: 'Montserrat', sans-serif;
            font-size: 12px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            
            /* CHANGE: Color red to stand out on black background */
            color: var(--color-primary-red);
            
            margin-top: 50px;
            border-top: 1px solid var(--color-primary-red);
            display: inline-block;
            padding-top: 15px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .hero-section { grid-template-columns: 1fr; text-align: center; }
            .hero-text { border-left: none; border-top: 5px solid var(--color-primary-red); }
            .main-layout { grid-template-columns: 1fr; }
            .controls-panel { position: static; margin-bottom: 40px; }
            .guide-steps { grid-template-columns: 1fr; }
            .badges-wrapper { flex-direction: column; gap: 20px; }
        }
    </style>
</head>
<body>

    <header>
        <div class="brand">
            <img src="slf_logo.png" alt="Solano Immigration Law Firm Logo" class="logo">
            <h1>Marketing Health Dashboard</h1>
        </div>
        <div style="font-size: 12px; font-weight: 600; color: var(--color-primary-red);">INTERNAL USE ONLY</div>
    </header>

    <section class="hero-section">
        <div class="hero-text">
            <h2>Data-Driven Decisions</h2>
            <p>
                Welcome to the <strong>Marketing Health Dashboard</strong>. This tool is designed for the <strong>Solano Immigration Law Firm</strong> team. 
                It analyzes Meta Ads and TikTok performance, visualizing critical metrics against our KPIs to optimize client acquisition strategies.
            </p>
        </div>
        <div class="hero-3d-container" id="scene-container">
            </div>
    </section>

    <section class="guide-section">
        <div class="guide-steps">
            <div class="step-card">
                <div class="step-number">1</div>
                <h3>Set Targets</h3>
                <p>Define your KPI targets in the sidebar (Cost per Lead, Views, Engagement) to calibrate the health scoring algorithm.</p>
            </div>
            <div class="step-card">
                <div class="step-number">2</div>
                <h3>Upload Data</h3>
                <p>Export your reports from Meta Ads Manager or TikTok Analytics as <strong>.xlsx</strong> files and upload them to the corresponding section.</p>
            </div>
            <div class="step-card">
                <div class="step-number">3</div>
                <h3>Filter & Analyze</h3>
                <p>Use the drop-down filters to select specific Accounts or States (e.g., GA, AL). Focus on items marked "Urgent".</p>
            </div>
        </div>
    </section>
    
    <div class="container">
        <main class="main-layout">
            <aside class="controls-panel">
                <h2>Parameters (KPIs)</h2>
                
                <div class="parameters-group">
                    <h3>Meta Ads Targets</h3>
                    <div class="control-group">
                        <label for="metaCostPerConversationTarget">Target CPA (Msg)</label>
                        <input id="metaCostPerConversationTarget" type="number" value="8" step="0.5">
                    </div>
                    <div class="control-group">
                        <label for="metaNewContactsTarget">Target Volume (Contacts)</label>
                        <input id="metaNewContactsTarget" type="number" value="150" step="1">
                    </div>
                    <div class="control-group">
                        <label for="metaReachTarget">Target Reach</label>
                        <input id="metaReachTarget" type="number" value="50000" step="1000">
                    </div>
                    <div class="control-group">
                        <label for="metaImpressionsTarget">Target Impressions</label>
                        <input id="metaImpressionsTarget" type="number" value="100000" step="1000">
                    </div>
                </div>

                <div class="parameters-group">
                    <h3>TikTok Targets</h3>
                    <div class="control-group">
                        <label for="tiktokViewsTarget">Target Views</label>
                        <input id="tiktokViewsTarget" type="number" value="5000" step="100">
                    </div>
                    <div class="control-group">
                        <label for="tiktokEngageTarget">Target Engagement %</label>
                        <input id="tiktokEngageTarget" type="number" value="8" step="0.5">
                    </div>
                    <div class="control-group">
                        <label for="tiktokWatchTimeTarget">Target Watch Time %</label>
                        <input id="tiktokWatchTimeTarget" type="number" value="60" step="1">
                    </div>
                    <div class="control-group">
                        <label for="tiktokRetentionTarget">Target Retention (3s) %</label>
                        <input id="tiktokRetentionTarget" type="number" value="70" step="1">
                    </div>
                </div>
            </aside>

            <div class="dashboard-sections">

                <section class="dashboard-level" id="tiktok-section">
                    <div class="section-header">
                        <h2>TikTok Posts</h2>
                        <div class="result-filters">
                            <label for="tiktokAccountFilter" style="font-size: 13px; font-weight: 600;">Filter by Account:</label>
                            <select id="tiktokAccountFilter"><option value="all">All Accounts</option></select>
                        </div>
                    </div>
                    <div class="level-content">
                        <div class="file-upload-area">
                            <div class="control-group">
                                <input type="file" id="xlsxFileTikTok" accept=".xlsx">
                                <label for="xlsxFileTikTok" class="file-upload-btn">Upload TikTok XLSX</label>
                                <p class="fileName" style="font-size: 12px; text-align: center; margin-top: 8px;"></p>
                            </div>
                        </div>
                        <div class="data-display-area">
                            <div class="summary-cards">
                                <div class="card"><div class="card-title">Total Posts</div><div class="card-value total-count">—</div></div>
                                <div class="card"><div class="card-title">Avg. Engagement</div><div class="card-value avg-engagement">—</div></div>
                                <div class="card"><div class="card-title">Action Required</div><div class="card-value action-count red">—</div></div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Health</th>
                                            <th>Date</th>
                                            <th>Account</th>
                                            <th>Video Link</th>
                                            <th>Views</th>
                                            <th>Eng. Rate</th>
                                            <th>Watch Time %</th>
                                            <th>Retention (3s)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-body"><tr><td colspan="8" style="text-align: center; padding: 40px;">Upload a file to see TikTok data.</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="dashboard-level" id="campaigns-section">
                    <div class="section-header">
                        <h2>Campaigns (Meta)</h2>
                        <div class="result-filters">
                            <label for="campaignsAccountFilter" style="font-size: 13px; font-weight: 600;">Filter by State:</label>
                            <select id="campaignsAccountFilter"><option value="all">All States</option></select>
                        </div>
                    </div>
                    <div class="level-content">
                        <div class="file-upload-area">
                            <input type="file" id="xlsxFileCampaigns" accept=".xlsx">
                            <label for="xlsxFileCampaigns" class="file-upload-btn">Upload Campaigns XLSX</label>
                            <p class="fileName" style="font-size: 12px; text-align: center; margin-top: 8px;"></p>
                        </div>
                        <div class="data-display-area">
                            <div class="summary-cards">
                                <div class="card"><div class="card-title">Total Campaigns</div><div class="card-value total-count">—</div></div>
                                <div class="card"><div class="card-title">Avg CPA</div><div class="card-value avg-cost">—</div></div>
                                <div class="card"><div class="card-title">Action Required</div><div class="card-value action-count red">—</div></div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead><tr><th>Health</th><th>Campaign Name</th><th>Amount Spent</th><th>New Contacts</th><th>CPA</th><th>Reach</th><th>Impressions</th></tr></thead>
                                    <tbody class="table-body"><tr><td colspan="8" style="text-align: center; padding: 40px;">Upload a file to see campaign data.</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="dashboard-level" id="ad-sets-section">
                    <div class="section-header">
                        <h2>Ad Sets (Meta)</h2>
                         <div class="result-filters">
                            <label for="adSetsAccountFilter" style="font-size: 13px; font-weight: 600;">Filter by State:</label>
                            <select id="adSetsAccountFilter"><option value="all">All States</option></select>
                        </div>
                    </div>
                     <div class="level-content">
                        <div class="file-upload-area">
                            <input type="file" id="xlsxFileAdSets" accept=".xlsx">
                            <label for="xlsxFileAdSets" class="file-upload-btn">Upload Ad Sets XLSX</label>
                            <p class="fileName" style="font-size: 12px; text-align: center; margin-top: 8px;"></p>
                        </div>
                        <div class="data-display-area">
                            <div class="summary-cards">
                                <div class="card"><div class="card-title">Total Ad Sets</div><div class="card-value total-count">—</div></div>
                                <div class="card"><div class="card-title">Avg CPA</div><div class="card-value avg-cost">—</div></div>
                                <div class="card"><div class="card-title">Action Required</div><div class="card-value action-count red">—</div></div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead><tr><th>Health</th><th>Ad Set Name</th><th>Amount Spent</th><th>New Contacts</th><th>CPA</th><th>Reach</th><th>Impressions</th></tr></thead>
                                    <tbody class="table-body"><tr><td colspan="8" style="text-align: center; padding: 40px;">Upload a file to see ad set data.</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="dashboard-level" id="ads-section">
                     <div class="section-header">
                        <h2>Ads (Meta)</h2>
                         <div class="result-filters">
                            <label for="adsAccountFilter" style="font-size: 13px; font-weight: 600;">Filter by State:</label>
                            <select id="adsAccountFilter"><option value="all">All States</option></select>
                        </div>
                    </div>
                     <div class="level-content">
                        <div class="file-upload-area">
                            <input type="file" id="xlsxFileAds" accept=".xlsx">
                            <label for="xlsxFileAds" class="file-upload-btn">Upload Ads XLSX</label>
                            <p class="fileName" style="font-size: 12px; text-align: center; margin-top: 8px;"></p>
                        </div>
                        <div class="data-display-area">
                            <div class="summary-cards">
                                <div class="card"><div class="card-title">Total Ads</div><div class="card-value total-count">—</div></div>
                                <div class="card"><div class="card-title">Avg CPA</div><div class="card-value avg-cost">—</div></div>
                                <div class="card"><div class="card-title">Action Required</div><div class="card-value action-count red">—</div></div>
                            </div>
                            <div class="table-container">
                                <table>
                                    <thead><tr><th>Health</th><th>Ad Name</th><th>Amount Spent</th><th>New Contacts</th><th>CPA</th><th>Reach</th><th>Impressions</th></tr></thead>
                                    <tbody class="table-body"><tr><td colspan="8" style="text-align: center; padding: 40px;">Upload a file to see ad data.</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <footer>
        <div class="credits-block">
            <p>Created by <strong>Jay Paulino</strong></p>
            <p>Engagement Coordinator</p>
        </div>
        
        <div class="badges-wrapper">
            
            <div class='academy-badge badge-item'>
                <a href='https://app.hubspot.com/academy/achievements/czbq9921/en/1/jay-paulino/social-media-marketing' title='Social Media Marketing' target="_blank">
                <img src='https://hubspot-credentials-na1.s3.amazonaws.com/prod/badges/user/0d3177673d894c379fe0977d290cda24.png' alt="Social Media Marketing Badge" />
                </a>
            </div>

            <div class="badge-item meta-badge">
                <div data-iframe-width="150" data-iframe-height="270" data-share-badge-id="96d65e88-747c-424f-a469-1d18c9eb4f15" data-share-badge-host="https://www.credly.com"></div>
                <script type="text/javascript" async src="//cdn.credly.com/assets/utilities/embed.js"></script>
            </div>

            <div class='academy-badge badge-item'>
                <a href='https://app.hubspot.com/academy/achievements/vrz0qnzb/en/1/jay-paulino/digital-marketing' title='Digital Marketing ' target="_blank">
                <img src='https://hubspot-credentials-na1.s3.amazonaws.com/prod/badges/user/b8dfa699f78a43718647d8a44acadaf9.png' alt="Digital Marketing Badge"/>
                </a>
            </div>

        </div>

        <div class="version-display">
            v.3.2.0
        </div>
    </footer>

<script>
    // ===========================================
    // == 3D STATISTICS GRAPH (Three.js) ==
    // ===========================================
    function init3D() {
        const container = document.getElementById('scene-container');
        if (!container) return;

        const scene = new THREE.Scene();
        scene.background = null; 

        const camera = new THREE.PerspectiveCamera(50, container.clientWidth / container.clientHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        
        renderer.setSize(container.clientWidth, container.clientHeight);
        container.appendChild(renderer.domElement);

        // Group to hold our bars
        const group = new THREE.Group();
        scene.add(group);

        // Create a 3D Bar Graph look
        const barCount = 10;
        const bars = [];
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshStandardMaterial({ 
            color: 0xa51710, // Brand Red
            roughness: 0.3,
            metalness: 0.2
        });
        const borderMaterial = new THREE.LineBasicMaterial({ color: 0x000000 });

        for (let i = 0; i < barCount; i++) {
            // Random heights for statistics look
            const height = Math.random() * 5 + 1; 
            const bar = new THREE.Mesh(geometry, material);
            
            // Position bars in a row
            bar.position.x = (i - barCount / 2) * 1.5;
            bar.position.y = height / 2; // Sit on ground
            bar.scale.y = height;
            
            // Store initial scale for animation
            bar.userData = { initialHeight: height, speed: Math.random() * 0.02 + 0.005, offset: Math.random() * Math.PI };

            group.add(bar);
            bars.push(bar);
        }

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7);
        scene.add(directionalLight);

        // Camera Positioning
        camera.position.set(0, 8, 15);
        camera.lookAt(0, 2, 0);

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Animate bars (Growth breathing effect)
            const time = Date.now() * 0.001;
            bars.forEach(bar => {
                const s = bar.userData;
                // Oscillate height slightly based on initial height
                const newHeight = s.initialHeight + Math.sin(time + s.offset) * 0.5;
                bar.scale.y = Math.max(0.5, newHeight);
                bar.position.y = bar.scale.y / 2;
            });

            // Gentle rotation of the whole graph
            group.rotation.y += 0.002;

            renderer.render(scene, camera);
        }
        animate();

        // Scroll Effect: Rotate the graph faster/change angle based on scroll
        window.addEventListener('scroll', () => {
            const scrollY = window.scrollY;
            group.rotation.y = scrollY * 0.005; 
            // Tilt slightly
            group.rotation.x = Math.sin(scrollY * 0.001) * 0.2;
        });

        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        });
    }

    // ===========================================
    // == DASHBOARD LOGIC ==
    // ===========================================
    document.addEventListener('DOMContentLoaded', () => {
        
        init3D(); // Start the 3D Graph

        // Inputs
        const metaCostPerConversationTargetInput = document.getElementById('metaCostPerConversationTarget');
        const metaNewContactsTargetInput = document.getElementById('metaNewContactsTarget');
        const metaReachTargetInput = document.getElementById('metaReachTarget'); 
        const metaImpressionsTargetInput = document.getElementById('metaImpressionsTarget');
        
        const tiktokViewsTargetInput = document.getElementById('tiktokViewsTarget');
        const tiktokEngageTargetInput = document.getElementById('tiktokEngageTarget');
        const tiktokWatchTimeTargetInput = document.getElementById('tiktokWatchTimeTarget');
        const tiktokRetentionTargetInput = document.getElementById('tiktokRetentionTarget');

        // Filters DOM Elements
        const tiktokAccountFilter = document.getElementById('tiktokAccountFilter');
        const campaignsAccountFilter = document.getElementById('campaignsAccountFilter');
        const adSetsAccountFilter = document.getElementById('adSetsAccountFilter');
        const adsAccountFilter = document.getElementById('adsAccountFilter');

        const dashboardState = {
            campaigns: { 
                data: [], nameKey: 'campaign name', headerKey: 'campaign name', requiredKey: 'impressions', 
                sectionId: 'campaigns-section', type: 'meta', filterElement: campaignsAccountFilter 
            },
            adSets: { 
                data: [], nameKey: 'ad set name', headerKey: 'ad set name', requiredKey: 'impressions', 
                sectionId: 'ad-sets-section', type: 'meta', filterElement: adSetsAccountFilter 
            },
            ads: { 
                data: [], nameKey: 'ad name', headerKey: 'ad name', requiredKey: 'impressions', 
                sectionId: 'ads-section', type: 'meta', filterElement: adsAccountFilter 
            },
            tiktok: { 
                data: [], nameKey: 'video link', headerKey: 'date posted', requiredKey: 'views', 
                sectionId: 'tiktok-section', type: 'tiktok', filterElement: tiktokAccountFilter 
            }
        };

        const TIKTOK_COLS = {
            DATE: 'date posted',
            ACCOUNT: 'account',
            LINK: 'video link',
            VIEWS: 'views',
            LIKES: 'likes',
            ENGAGEMENT_RATE: 'engagement rate (4-8% strong - 10%+ excellent)',
            AVG_WATCH_TIME_PERCENT: 'average watch time % (60%)',
            RETENTION_3S: 'retention rate at 3 sec (65% is good 75%+ is excellent)'
        };

        // Initialize Listeners
        function init() {
            // Parameter Change Listeners
            [metaCostPerConversationTargetInput, metaNewContactsTargetInput, metaReachTargetInput, metaImpressionsTargetInput,
             tiktokViewsTargetInput, tiktokEngageTargetInput, tiktokWatchTimeTargetInput, tiktokRetentionTargetInput]
             .forEach(input => input.addEventListener('input', reRenderAllLevels));

            // File Upload Listeners
            document.getElementById('xlsxFileCampaigns').addEventListener('change', (e) => handleFileSelect(e, 'campaigns'));
            document.getElementById('xlsxFileAdSets').addEventListener('change', (e) => handleFileSelect(e, 'adSets'));
            document.getElementById('xlsxFileAds').addEventListener('change', (e) => handleFileSelect(e, 'ads'));
            document.getElementById('xlsxFileTikTok').addEventListener('change', (e) => handleFileSelect(e, 'tiktok'));

            // Filter Change Listeners
            tiktokAccountFilter.addEventListener('change', () => renderData('tiktok'));
            campaignsAccountFilter.addEventListener('change', () => renderData('campaigns'));
            adSetsAccountFilter.addEventListener('change', () => renderData('adSets'));
            adsAccountFilter.addEventListener('change', () => renderData('ads'));
        }
        
        function reRenderAllLevels() {
            Object.keys(dashboardState).forEach(level => {
                if (dashboardState[level].data.length > 0) renderData(level);
            });
        }

        function handleFileSelect(event, level) {
            const file = event.target.files[0];
            const levelConfig = dashboardState[level];
            const section = document.getElementById(levelConfig.sectionId);
            const fileNameDisplay = section.querySelector('.fileName');
            
            if (!file) { fileNameDisplay.textContent = ''; return; }

            fileNameDisplay.textContent = `File: ${file.name}`;
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    let rows;
                    if (level === 'tiktok') {
                        rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: false, dateNF: 'm/d/yyyy' });
                    } else {
                        rows = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "", raw: true });
                    }

                    // Find Header Row
                    let headerRowIndex = -1;
                    for (let i = 0; i < Math.min(rows.length, 15); i++) {
                        const processedRow = rows[i].map(h => String(h).trim().toLowerCase());
                        if (processedRow.includes(levelConfig.headerKey) && processedRow.includes(levelConfig.requiredKey)) {
                            headerRowIndex = i;
                            break;
                        }
                    }

                    if (headerRowIndex === -1) throw new Error("Could not find valid headers.");

                    const headers = rows[headerRowIndex].map(h => String(h).trim().toLowerCase());
                    const dataRows = rows.slice(headerRowIndex + 1);

                    const jsonData = dataRows.map(row => {
                        const obj = {};
                        headers.forEach((header, index) => { if(header) obj[header] = row[index]; });
                        return obj;
                    }).filter(row => row[levelConfig.nameKey] && String(row[levelConfig.nameKey]).trim() !== '');

                    levelConfig.data = jsonData;
                    
                    // Populate Filters
                    populateFilter(level, jsonData);

                    renderData(level);

                } catch (error) {
                    console.error(error);
                    section.querySelector('.table-body').innerHTML = `<tr><td colspan="8" style="color:red;">Error: ${error.message}</td></tr>`;
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- FILTER LOGIC ---
        function populateFilter(level, data) {
            const config = dashboardState[level];
            const select = config.filterElement;
            
            // Determine default text based on level
            const defaultText = (level === 'tiktok') ? "All Accounts" : "All States";
            select.innerHTML = `<option value="all">${defaultText}</option>`;
            
            let uniqueValues = new Set();
            let keyToFilter = '';

            if (level === 'tiktok') {
                keyToFilter = TIKTOK_COLS.ACCOUNT;
                // Standard Collection for TikTok
                data.forEach(row => {
                    const val = row[keyToFilter];
                    if (val) uniqueValues.add(String(val).trim());
                });
            } else {
                // META LOGIC: Detect "GA" or "AL" as WHOLE WORDS in the Name Field
                // Uses Regex \bGA\b and \bAL\b to avoid matching inside words (e.g., DigitAL, LegAL)
                keyToFilter = config.nameKey; 
                
                const regexGA = /\bGA\b/i;
                const regexAL = /\bAL\b/i;

                data.forEach(row => {
                    const nameVal = String(row[keyToFilter] || "");
                    if (regexGA.test(nameVal)) uniqueValues.add("GA");
                    if (regexAL.test(nameVal)) uniqueValues.add("AL");
                });
            }

            config.filterKey = keyToFilter;

            Array.from(uniqueValues).sort().forEach(val => {
                const option = document.createElement('option');
                option.value = val;
                option.textContent = val;
                select.appendChild(option);
            });
        }

        function renderData(level) {
            const config = dashboardState[level];
            const tableBody = document.getElementById(config.sectionId).querySelector('.table-body');
            
            // Apply Filter
            let filteredData = config.data;
            const filterVal = config.filterElement.value;
            
            if (filterVal !== 'all') {
                if (level === 'tiktok') {
                    // Exact match for TikTok Account
                    filteredData = filteredData.filter(row => String(row[config.filterKey]).trim() === filterVal);
                } else {
                    // Strict Word Boundary match for Meta (finding " GA " or " AL " as whole words)
                    const regex = new RegExp(`\\b${filterVal}\\b`, 'i');
                    filteredData = filteredData.filter(row => regex.test(String(row[config.nameKey])));
                }
            }

            if (config.type === 'tiktok') {
                renderTikTokTable(filteredData, tableBody);
            } else {
                renderMetaTable(filteredData, tableBody, level);
            }
        }

        // --- COLOR HELPER FOR METRICS ---
        function getMetricClass(value, target, isLowerBetter = false) {
            if (!target || isNaN(value)) return 'text-neutral';
            
            const ratio = value / target;

            if (isLowerBetter) {
                // Lower is better (e.g. CPA)
                if (ratio <= 0.8) return 'text-excellent';
                if (ratio <= 1.0) return 'text-good';
                if (ratio <= 1.2) return 'text-review';
                if (ratio <= 1.5) return 'text-attention';
                return 'text-urgent';
            } else {
                // Higher is better (e.g. Views, Reach)
                if (ratio >= 1.1) return 'text-excellent';
                if (ratio >= 1.0) return 'text-good';
                if (ratio >= 0.8) return 'text-review';
                if (ratio >= 0.6) return 'text-attention';
                return 'text-urgent';
            }
        }

        // --- RENDERERS ---

        function renderTikTokTable(data, tableBody) {
            const targets = { 
                views: sanitizeNumber(tiktokViewsTargetInput.value),
                engage: sanitizeNumber(tiktokEngageTargetInput.value), 
                watch: sanitizeNumber(tiktokWatchTimeTargetInput.value), 
                retention: sanitizeNumber(tiktokRetentionTargetInput.value) 
            };

            const processed = data.map(row => {
                const healthInfo = getTikTokHealth(row, targets);
                return { ...row, healthInfo };
            });

            processed.sort((a, b) => b.healthInfo.health - a.healthInfo.health);

            tableBody.innerHTML = '';
            processed.forEach(row => {
                const { health, color, label } = row.healthInfo;
                const link = row[TIKTOK_COLS.LINK] || '#';
                const displayLink = link !== '#' ? `<a href="${link}" target="_blank">View Video</a>` : 'N/A';
                
                // Get Raw Values
                const views = sanitizeNumber(row[TIKTOK_COLS.VIEWS]);
                const eng = sanitizePercentage(row[TIKTOK_COLS.ENGAGEMENT_RATE]);
                const watch = sanitizePercentage(row[TIKTOK_COLS.AVG_WATCH_TIME_PERCENT]);
                const ret = sanitizePercentage(row[TIKTOK_COLS.RETENTION_3S]);

                // Get Color Classes
                const viewsClass = getMetricClass(views, targets.views, false);
                const engClass = getMetricClass(eng, targets.engage, false);
                const watchClass = getMetricClass(watch, targets.watch, false);
                const retClass = getMetricClass(ret, targets.retention, false);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><div class="health-cell"><span class="health-score" style="background-color: ${color};">${health}</span></div></td>
                    <td>${row[TIKTOK_COLS.DATE] || '-'}</td>
                    <td>${row[TIKTOK_COLS.ACCOUNT] || '-'}</td>
                    <td class="video-link-cell">${displayLink}</td>
                    <td class="${viewsClass}">${views || 0}</td>
                    <td class="${engClass}">${eng || 0}%</td>
                    <td class="${watchClass}">${watch || 0}%</td>
                    <td class="${retClass}">${ret || 0}%</td>
                `;
                tableBody.appendChild(tr);
            });
            updateSummaryCards(processed, 'tiktok');
        }

        function renderMetaTable(data, tableBody, level) {
            const targets = {
                cpa: sanitizeNumber(document.getElementById('metaCostPerConversationTarget').value),
                contacts: sanitizeNumber(document.getElementById('metaNewContactsTarget').value),
                reach: sanitizeNumber(document.getElementById('metaReachTarget').value),
                impressions: sanitizeNumber(document.getElementById('metaImpressionsTarget').value)
            };

            const processed = data.map(row => {
                const healthInfo = getMetaHealth(row, targets);
                return { ...row, healthInfo };
            });

            processed.sort((a, b) => b.healthInfo.health - a.healthInfo.health);

            tableBody.innerHTML = '';
            const config = dashboardState[level];
            
            processed.forEach(row => {
                const { health, color } = row.healthInfo;
                
                const spendVal = sanitizeNumber(row['amount spent (usd)'] || row['amount spent']);
                const contactsVal = sanitizeNumber(row['new messaging contacts']);
                const cpaVal = sanitizeNumber(row['cost per messaging conversation started (usd)']);
                const reachVal = sanitizeNumber(row['reach']);
                const impVal = sanitizeNumber(row['impressions']);

                // Calculate Color Classes for each cell
                const contactsClass = getMetricClass(contactsVal, targets.contacts, false); // Higher better
                const cpaClass = getMetricClass(cpaVal, targets.cpa, true); // Lower better
                const reachClass = getMetricClass(reachVal, targets.reach, false); // Higher better
                const impClass = getMetricClass(impVal, targets.impressions, false); // Higher better

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><div class="health-cell"><span class="health-score" style="background-color: ${color};">${health}</span></div></td>
                    <td>${row[config.nameKey] || '-'}</td>
                    <td>$${spendVal || 0}</td>
                    <td class="${contactsClass}">${contactsVal || 0}</td>
                    <td class="${cpaClass}">$${cpaVal || 0}</td>
                    <td class="${reachClass}">${reachVal || 0}</td>
                    <td class="${impClass}">${impVal || 0}</td>
                `;
                tableBody.appendChild(tr);
            });
            updateSummaryCards(processed, level);
        }

        // --- HEALTH LOGIC ---
        function getTikTokHealth(row, t) {
            const views = sanitizeNumber(row[TIKTOK_COLS.VIEWS]);
            const eng = sanitizePercentage(row[TIKTOK_COLS.ENGAGEMENT_RATE]);
            
            // Weighted Logic
            let score = 0;
            if (views >= t.views) score += 40; else score += (views/t.views)*40;
            if (eng >= t.engage) score += 60; else score += (eng/t.engage)*60;
            
            score = Math.round(score);
            return getColorLabel(score);
        }

        function getMetaHealth(row, t) {
            // Split weight between 4 main metrics
            let score = 0;
            const weightPerMetric = 25; 

            // 1. CPA (Lower is better)
            const cpa = sanitizeNumber(row['cost per messaging conversation started (usd)']);
            if (cpa > 0) {
                if (cpa <= t.cpa) score += weightPerMetric; // Met target
                else {
                    const penalty = (cpa - t.cpa) / t.cpa;
                    score += Math.max(0, (1 - penalty) * weightPerMetric);
                }
            }

            // 2. Contacts (Higher is better)
            const contacts = sanitizeNumber(row['new messaging contacts']);
            if (contacts >= t.contacts) score += weightPerMetric; 
            else score += (contacts/t.contacts)*weightPerMetric;
            
            // 3. Reach (Higher is better)
            const reach = sanitizeNumber(row['reach']);
            if (reach >= t.reach) score += weightPerMetric;
            else score += (reach/t.reach)*weightPerMetric;

            // 4. Impressions (Higher is better)
            const imp = sanitizeNumber(row['impressions']);
            if (imp >= t.impressions) score += weightPerMetric;
            else score += (imp/t.impressions)*weightPerMetric;

            score = Math.round(score || 0);
            return getColorLabel(score);
        }

        function getColorLabel(score) {
            if (isNaN(score)) return { health: 0, color: 'gray', label: 'N/A' };
            let color;
            if (score >= 80) color = 'var(--health-excellent)';
            else if (score >= 60) color = 'var(--health-good)';
            else if (score >= 40) color = 'var(--health-review)';
            else color = 'var(--health-urgent)';
            return { health: score, color, label: '' };
        }

        function updateSummaryCards(data, level) {
            const section = document.getElementById(dashboardState[level].sectionId);
            const total = data.length;
            const urgent = data.filter(d => d.healthInfo.health < 40).length;
            
            let avgText = '';
            if (level === 'tiktok') {
                 // Calc Avg Eng
                 let sumEng = 0;
                 data.forEach(d => sumEng += (sanitizePercentage(d[TIKTOK_COLS.ENGAGEMENT_RATE]) || 0));
                 avgText = (total > 0) ? (sumEng / total).toFixed(2) + '%' : '-';
            } else {
                 // Calc CPA
                 let spend = 0, contacts = 0;
                 data.forEach(d => {
                     spend += sanitizeNumber(d['amount spent (usd)'] || d['amount spent']) || 0;
                     contacts += sanitizeNumber(d['new messaging contacts']) || 0;
                 });
                 avgText = contacts > 0 ? '$' + (spend/contacts).toFixed(2) : '-';
            }

            section.querySelector('.total-count').textContent = total;
            section.querySelector('.action-count').textContent = urgent;
            if(level === 'tiktok') section.querySelector('.avg-engagement').textContent = avgText;
            else section.querySelector('.avg-cost').textContent = avgText;
        }

        function sanitizeNumber(val) {
            if (!val) return 0;
            return Number(String(val).replace(/[^0-9.-]/g, ''));
        }
        function sanitizePercentage(val) {
            return sanitizeNumber(val);
        }

        init();
    });
</script>
</body>
</html>
